#!/bin/bash
set -o pipefail

# ====== Configuration ======
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
LOG_FILE="/mnt/user/logs/SONARR_import.log"

SONARR_API_KEY="API-KEY"
SONARR_URL="http://localhost:8989"

# Local path where files land (mounted into your rclone container as /data)
SONARR_IMPORT_PATH="/mnt/user/media/incoming"

# Path *inside* the rclone container that maps to SONARR_IMPORT_PATH
RCLONE_DEST_PATH="/data/incoming"

# Name of your rclone Docker container (e.g., binhex-rclone)
RCLONE_CONTAINER="binhex-rclone"
RCLONE_CONFIG_PATH="/config/rclone/config/rclone.conf"

# Remote path
RCLONE_REMOTE="sample:/home/path/"

RCLONE_TRANSFERS=2
RCLONE_CHECKERS=2
RCLONE_BWLIMIT=""
# ============================

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE" ; }

mkdir -p "$(dirname "$LOG_FILE")" "$SONARR_IMPORT_PATH"

log "Starting rclone sync via Dockerâ€¦"

RARGS=(sync
   --config="$RCLONE_CONFIG_PATH"
   "$RCLONE_REMOTE"
   "$RCLONE_DEST_PATH"
   --create-empty-src-dirs
   --transfers="$RCLONE_TRANSFERS"
   --checkers="$RCLONE_CHECKERS"
   --ignore-existing
   --size-only
   --progress
   --stats=30s
)

if [[ -n "$RCLONE_BWLIMIT" ]]; then
  RARGS+=(--bwlimit "$RCLONE_BWLIMIT")
fi

docker exec "$RCLONE_CONTAINER" rclone "${RARGS[@]}" >> "$LOG_FILE" 2>&1
RC=$?

if [[ $RC -ne 0 ]]; then
  log "âŒ rclone sync failed with exit code $RC"
  exit $RC
fi

log "âœ… rclone sync completed."

# =====================================================================
#        EXTRACTION + MEDIA DETECTION + SAMPLE REMOVAL UPGRADE
# =====================================================================

log "Scanning for .rar files to extract..."

# Choose extraction tool
EXTRACTOR=""
if command -v unrar >/dev/null 2>&1; then
  EXTRACTOR="unrar x -o+ -y"
elif command -v 7z >/dev/null 2>&1; then
  EXTRACTOR="7z x -y"
else
  log "âŒ ERROR: No extractor available (unrar/7z missing)"
fi

if [[ -n "$EXTRACTOR" ]]; then
  find "$SONARR_IMPORT_PATH" -type f \( -iname '*.part1.rar' -o -iname '*.rar' \) | while read -r rarfile; do
    extract_dir="$(dirname "$rarfile")"
    log "ğŸ“¦ Extracting: $rarfile â†’ $extract_dir"

    $EXTRACTOR "$rarfile" -o"$extract_dir" >> "$LOG_FILE" 2>&1

    # ====== Remove samples ======
    log "ğŸ” Removing sample files in $extract_dir..."
    find "$extract_dir" -maxdepth 1 -type f -iname "sample.*" -print -delete >> "$LOG_FILE" 2>&1

    # ====== Detect media files ======
    log "ğŸ” Detecting media files in $extract_dir..."

    mapfile -t media_files < <(
      find "$extract_dir" -maxdepth 1 -type f \( \
         -iname '*.mkv' -o -iname '*.mp4' -o -iname '*.avi' -o -iname '*.mov' \
      \)
    )

    if [[ ${#media_files[@]} -eq 0 ]]; then
      log "âŒ No media files found after extraction! Skipping cleanup to avoid data loss."
      continue
    fi

    # ====== Find largest media file ======
    largest_media=$(ls -S "${media_files[@]}" 2>/dev/null | head -n 1)

    log "ğŸ¥ Largest extracted media file: $(basename "$largest_media")"

    # ====== Cleanup archive files ONLY AFTER confirming the media exists ======
    log "ğŸ§¼ Cleaning up archive parts in $extract_dirâ€¦"

    find "$extract_dir" -maxdepth 1 -type f \
      \( \
        -iname '*.rar' \
        -o -regex '.*\.part[0-9]+\.rar$' \
        -o -regex '.*\.r[0-9][0-9]$' \
        -o -iname '*.rev' \
      \) -print -delete >> "$LOG_FILE" 2>&1

    log "âœ… Cleanup completed for: $extract_dir"

  done
else
  log "âš ï¸ Extraction skipped â€” no extractor available."
fi

log "âœ… Extraction phase complete."

# =====================================================================
#                 SONARR IMPORT TRIGGER
# =====================================================================
log "Starting SONARR import for: $SONARR_IMPORT_PATH"

RESPONSE=$(curl -s -w "\nHTTP_STATUS_CODE:%{http_code}" -X POST "${SONARR_URL}/api/v3/command" \
     -H "X-Api-Key: ${SONARR_API_KEY}" \
     -H "Content-Type: application/json" \
     -d "{\"name\": \"manualImport\", \"path\": \"${SONARR_IMPORT_PATH}\", \"importMode\": \"move\"}")

HTTP_CODE=$(echo "$RESPONSE" | awk -F: '/HTTP_STATUS_CODE/ {print $2}')
BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS_CODE/d')

if [[ "$HTTP_CODE" == "201" || "$HTTP_CODE" == "200" ]]; then
  log "âœ… SONARR import successful."
else
  log "âŒ ERROR: SONARR returned HTTP $HTTP_CODE"
  log "Response body: $BODY"
fi

# =====================================================================
#               PERMISSION FIX
# =====================================================================
if chown -R nobody:users "$SONARR_IMPORT_PATH" 2>>"$LOG_FILE"; then
  log "âœ… Permissions fixed for $SONARR_IMPORT_PATH"
else
  log "âš ï¸ Permission fix failed â€” manual check recommended."
fi

# Cleanup old logs
find "$(dirname "$LOG_FILE")" -type f -name "$(basename "$LOG_FILE")" -mtime +30 -delete 2>>"$LOG_FILE"

log "ğŸ Script completed."
